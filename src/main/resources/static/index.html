<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .task-item {
            transition: all 0.2s ease;
        }
        .task-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .important-star {
            color: #fbbf24;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login View -->
    <div id="loginView" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="max-w-md w-full space-y-8 p-8 bg-white rounded-xl shadow-lg">
            <div class="text-center">
                <i class="fas fa-tasks text-4xl text-blue-600 mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-900">ToDo App</h2>
                <p class="mt-2 text-gray-600">Sign in to manage your tasks</p>
            </div>
            <form id="loginForm" class="mt-8 space-y-6">
                <div class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input id="username" name="username" type="text" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input id="password" name="password" type="password" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <button type="submit"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                        Sign in
                    </button>
                </div>
                <div class="text-sm text-gray-600 text-center">
                    <div>Demo accounts:</div>
                    <div>Admin: admin / admin123</div>
                    <div>User: user / user123</div>
                </div>
            </form>
            <div id="loginError" class="text-red-600 text-sm text-center hidden"></div>
        </div>
    </div>

    <!-- Main App View -->
    <div id="appView" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-tasks text-2xl text-blue-600"></i>
                        <h1 class="text-2xl font-bold text-gray-900">ToDo App</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userInfo" class="text-sm text-gray-600"></span>
                        <button id="logoutBtn"
                                class="text-sm text-gray-500 hover:text-gray-700 transition duration-200">
                            <i class="fas fa-sign-out-alt mr-1"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex max-w-7xl mx-auto">
            <!-- Sidebar -->
            <div class="w-64 bg-white shadow-sm min-h-screen border-r">
                <nav class="mt-8">
                    <div class="px-4 space-y-2">
                        <a href="#" id="dailyTasks" class="sidebar-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 transition duration-200 bg-blue-50 border-r-2 border-blue-500">
                            <i class="fas fa-sun text-orange-500 mr-3"></i>
                            <span class="font-medium">My Day</span>
                        </a>
                        <a href="#" id="importantTasks" class="sidebar-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 transition duration-200">
                            <i class="fas fa-star text-yellow-500 mr-3"></i>
                            <span class="font-medium">Important</span>
                        </a>
                        <a href="#" id="assignedToMe" class="sidebar-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 transition duration-200">
                            <i class="fas fa-user text-blue-500 mr-3"></i>
                            <span class="font-medium">Assigned to me</span>
                        </a>
                    </div>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="flex-1 p-6">
                <div class="max-w-4xl">
                    <!-- Current View Title -->
                    <div class="mb-6">
                        <h2 id="currentViewTitle" class="text-2xl font-bold text-gray-900 flex items-center">
                            <i id="currentViewIcon" class="fas fa-sun text-orange-500 mr-3"></i>
                            My Day
                        </h2>
                        <p id="currentViewSubtitle" class="text-gray-600 mt-1">Tasks for today</p>
                    </div>

                    <!-- Add Task Form -->
                    <div class="mb-6 bg-white rounded-lg shadow-sm border p-4">
                        <div class="flex space-x-3">
                            <div class="flex-1">
                                <input id="newTaskTitle" type="text" placeholder="Add a task"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <button id="addTaskBtn"
                                    class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        <!-- Admin Assignment Dropdown (hidden by default) -->
                        <div id="adminAssignment" class="mt-3 hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Assign to:</label>
                            <select id="assigneeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Assign to myself</option>
                            </select>
                        </div>

                        <!-- Task Details (expandable) -->
                        <div id="taskDetailsForm" class="mt-3 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea id="newTaskDescription" rows="2"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                                    <input id="newTaskDueDate" type="date"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="mt-3 flex items-center">
                                <input id="newTaskImportant" type="checkbox"
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="newTaskImportant" class="ml-2 text-sm text-gray-700">Mark as important</label>
                            </div>
                        </div>

                        <button id="toggleDetailsBtn"
                                class="mt-2 text-sm text-blue-600 hover:text-blue-800 transition duration-200">
                            <i class="fas fa-chevron-down mr-1"></i>
                            Add details
                        </button>
                    </div>

                    <!-- Tasks List -->
                    <div id="tasksList" class="space-y-2">
                        <!-- Tasks will be dynamically loaded here -->
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-12 hidden">
                        <i class="fas fa-clipboard-list text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-500">No tasks yet</h3>
                        <p class="text-gray-400">Add a task above to get started</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div id="taskModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Task Details</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="modalContent">
                    <!-- Modal content will be dynamically loaded -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let currentView = 'daily';
        let allUsers = [];

        // DOM elements
        const loginView = document.getElementById('loginView');
        const appView = document.getElementById('appView');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const tasksList = document.getElementById('tasksList');
        const emptyState = document.getElementById('emptyState');
        const newTaskTitle = document.getElementById('newTaskTitle');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('userInfo');

        // Navigation elements
        const dailyTasksNav = document.getElementById('dailyTasks');
        const importantTasksNav = document.getElementById('importantTasks');
        const assignedToMeNav = document.getElementById('assignedToMe');

        // View title elements
        const currentViewTitle = document.getElementById('currentViewTitle');
        const currentViewIcon = document.getElementById('currentViewIcon');
        const currentViewSubtitle = document.getElementById('currentViewSubtitle');

        // Task form elements
        const taskDetailsForm = document.getElementById('taskDetailsForm');
        const toggleDetailsBtn = document.getElementById('toggleDetailsBtn');
        const adminAssignment = document.getElementById('adminAssignment');
        const assigneeSelect = document.getElementById('assigneeSelect');

        // Modal elements
        const taskModal = document.getElementById('taskModal');
        const closeModal = document.getElementById('closeModal');
        const modalContent = document.getElementById('modalContent');

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            addTaskBtn.addEventListener('click', handleAddTask);
            newTaskTitle.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleAddTask();
                }
            });

            // Navigation
            dailyTasksNav.addEventListener('click', () => switchView('daily'));
            importantTasksNav.addEventListener('click', () => switchView('important'));
            assignedToMeNav.addEventListener('click', () => switchView('assigned'));

            // Task details toggle
            toggleDetailsBtn.addEventListener('click', toggleTaskDetails);

            // Modal
            closeModal.addEventListener('click', closeTaskModal);
            taskModal.addEventListener('click', function(e) {
                if (e.target === taskModal) {
                    closeTaskModal();
                }
            });
        }

        // Authentication functions
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/me');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        currentUser = data;
                        showApp();
                        return;
                    }
                }
            } catch (error) {
                console.log('Not authenticated');
            }
            showLogin();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);

                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data;
                    showApp();
                } else {
                    showError(data.message || 'Login failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
            } catch (error) {
                console.log('Logout error:', error);
            }
            currentUser = null;
            showLogin();
        }

        function showLogin() {
            loginView.classList.remove('hidden');
            appView.classList.add('hidden');
            loginError.classList.add('hidden');
            loginForm.reset();
        }

        function showApp() {
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            userInfo.textContent = `${currentUser.username} (${currentUser.role.replace('ROLE_', '')})`;

            if (currentUser.role === 'ROLE_ADMIN') {
                loadUsers();
                adminAssignment.classList.remove('hidden');
            }

            switchView('daily');
        }

        function showError(message) {
            loginError.textContent = message;
            loginError.classList.remove('hidden');
        }

        // User management
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    allUsers = await response.json();
                    populateUserDropdown();
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function populateUserDropdown() {
            assigneeSelect.innerHTML = '<option value="">Assign to myself</option>';
            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.username;
                assigneeSelect.appendChild(option);
            });
        }

        // View switching
        function switchView(view) {
            currentView = view;

            // Update navigation active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('bg-blue-50', 'border-r-2', 'border-blue-500');
            });

            let title, icon, subtitle, navElement;

            switch(view) {
                case 'daily':
                    title = 'My Day';
                    icon = 'fas fa-sun text-orange-500';
                    subtitle = 'Tasks for today';
                    navElement = dailyTasksNav;
                    break;
                case 'important':
                    title = 'Important';
                    icon = 'fas fa-star text-yellow-500';
                    subtitle = 'Important tasks';
                    navElement = importantTasksNav;
                    break;
                case 'assigned':
                    title = 'Assigned to me';
                    icon = 'fas fa-user text-blue-500';
                    subtitle = 'All your tasks';
                    navElement = assignedToMeNav;
                    break;
            }

            currentViewTitle.innerHTML = `<i class="${icon} mr-3"></i>${title}`;
            currentViewSubtitle.textContent = subtitle;
            navElement.classList.add('bg-blue-50', 'border-r-2', 'border-blue-500');

            loadTasks();
        }

        // Task management
        async function loadTasks() {
            try {
                let endpoint;
                switch(currentView) {
                    case 'daily':
                        endpoint = '/api/tasks/daily';
                        break;
                    case 'important':
                        endpoint = '/api/tasks/important';
                        break;
                    case 'assigned':
                        endpoint = '/api/tasks/assigned-to-me';
                        break;
                }

                const response = await fetch(endpoint);
                if (response.ok) {
                    const tasks = await response.json();
                    renderTasks(tasks);
                } else {
                    console.error('Error loading tasks');
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        function renderTasks(tasks) {
            tasksList.innerHTML = '';

            if (tasks.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            tasks.forEach(task => {
                const taskElement = createTaskElement(task);
                tasksList.appendChild(taskElement);
            });
        }

        function createTaskElement(task) {
            const div = document.createElement('div');
            div.className = 'task-item bg-white rounded-lg shadow-sm border p-4 fade-in';
            div.dataset.taskId = task.id;

            const completedClass = task.isCompleted ? 'completed' : '';
            const dueDateText = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : '';
            const importantClass = task.isImportant ? 'important-star' : 'text-gray-300';

            div.innerHTML = `
                <div class="flex items-start space-x-3">
                    <button class="task-checkbox mt-1 w-5 h-5 border-2 border-gray-300 rounded hover:border-blue-500 transition-colors duration-200 flex items-center justify-center ${task.isCompleted ? 'bg-blue-500 border-blue-500' : ''}">
                        ${task.isCompleted ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                    </button>
                    <div class="flex-1 cursor-pointer" onclick="openTaskModal(${task.id})">
                        <h3 class="font-medium text-gray-900 ${completedClass}">${task.title}</h3>
                        ${task.description ? `<p class="text-sm text-gray-600 mt-1 ${completedClass}">${task.description}</p>` : ''}
                        ${dueDateText ? `<p class="text-xs text-gray-500 mt-1">Due: ${dueDateText}</p>` : ''}
                    </div>
                    <button class="importance-btn text-xl hover:scale-110 transition-transform duration-200 ${importantClass}">
                        <i class="fas fa-star"></i>
                    </button>
                </div>
            `;

            // Add event listeners
            const checkbox = div.querySelector('.task-checkbox');
            const importanceBtn = div.querySelector('.importance-btn');

            checkbox.addEventListener('click', () => toggleTaskCompletion(task.id, !task.isCompleted));
            importanceBtn.addEventListener('click', () => toggleTaskImportance(task.id, !task.isImportant));

            return div;
        }

        async function handleAddTask() {
            const title = newTaskTitle.value.trim();
            if (!title) return;

            const taskData = {
                title: title,
                description: document.getElementById('newTaskDescription').value.trim(),
                dueDate: document.getElementById('newTaskDueDate').value || null,
                isImportant: document.getElementById('newTaskImportant').checked,
                isCompleted: false
            };

            if (currentUser.role === 'ROLE_ADMIN' && assigneeSelect.value) {
                taskData.assigneeId = parseInt(assigneeSelect.value);
            }

            try {
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(taskData)
                });

                if (response.ok) {
                    clearTaskForm();
                    loadTasks();
                } else {
                    console.error('Error creating task');
                }
            } catch (error) {
                console.error('Error creating task:', error);
            }
        }

        async function toggleTaskCompletion(taskId, isCompleted) {
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ isCompleted: isCompleted })
                });

                if (response.ok) {
                    loadTasks();
                }
            } catch (error) {
                console.error('Error updating task:', error);
            }
        }

        async function toggleTaskImportance(taskId, isImportant) {
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ isImportant: isImportant })
                });

                if (response.ok) {
                    loadTasks();
                }
            } catch (error) {
                console.error('Error updating task:', error);
            }
        }

        function clearTaskForm() {
            newTaskTitle.value = '';
            document.getElementById('newTaskDescription').value = '';
            document.getElementById('newTaskDueDate').value = '';
            document.getElementById('newTaskImportant').checked = false;
            assigneeSelect.value = '';
            taskDetailsForm.classList.add('hidden');
            toggleDetailsBtn.innerHTML = '<i class="fas fa-chevron-down mr-1"></i>Add details';
        }

        function toggleTaskDetails() {
            const isHidden = taskDetailsForm.classList.contains('hidden');
            if (isHidden) {
                taskDetailsForm.classList.remove('hidden');
                toggleDetailsBtn.innerHTML = '<i class="fas fa-chevron-up mr-1"></i>Hide details';
            } else {
                taskDetailsForm.classList.add('hidden');
                toggleDetailsBtn.innerHTML = '<i class="fas fa-chevron-down mr-1"></i>Add details';
            }
        }

        // Modal functions
        async function openTaskModal(taskId) {
            try {
                const endpoint = currentView === 'assigned' ? '/api/tasks/assigned-to-me' :
                               currentView === 'important' ? '/api/tasks/important' : '/api/tasks/daily';

                const response = await fetch(endpoint);
                if (response.ok) {
                    const tasks = await response.json();
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        showTaskModal(task);
                    }
                }
            } catch (error) {
                console.error('Error loading task details:', error);
            }
        }

        function showTaskModal(task) {
            const dueDateText = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date';

            modalContent.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-start justify-between">
                        <h4 class="text-xl font-semibold text-gray-900">${task.title}</h4>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${task.isImportant ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                            ${task.isImportant ? '⭐ Important' : 'Normal'}
                        </span>
                    </div>
                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                        <span class="flex items-center">
                            <i class="fas fa-calendar mr-2"></i>
                            ${dueDateText}
                        </span>
                        <span class="flex items-center">
                            <i class="fas fa-user mr-2"></i>
                            ${task.assigneeName}
                        </span>
                        <span class="flex items-center">
                            <i class="fas fa-check-circle mr-2 ${task.isCompleted ? 'text-green-500' : 'text-gray-400'}"></i>
                            ${task.isCompleted ? 'Completed' : 'Pending'}
                        </span>
                    </div>
                    ${task.description ? `
                        <div class="border-t pt-4">
                            <h5 class="font-medium text-gray-900 mb-2">Description</h5>
                            <p class="text-gray-700 whitespace-pre-wrap">${task.description}</p>
                        </div>
                    ` : ''}
                    <div class="border-t pt-4 flex space-x-3">
                        <button onclick="toggleTaskCompletion(${task.id}, ${!task.isCompleted})"
                                class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-200">
                            ${task.isCompleted ? 'Mark as Pending' : 'Mark as Completed'}
                        </button>
                        <button onclick="toggleTaskImportance(${task.id}, ${!task.isImportant})"
                                class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-200">
                            ${task.isImportant ? 'Remove from Important' : 'Mark as Important'}
                        </button>
                        <button onclick="deleteTask(${task.id})"
                                class="py-2 px-4 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700 transition duration-200">
                            Delete
                        </button>
                    </div>
                </div>
            `;

            taskModal.classList.remove('hidden');
        }

        function closeTaskModal() {
            taskModal.classList.add('hidden');
        }

        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }

            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    closeTaskModal();
                    loadTasks();
                }
            } catch (error) {
                console.error('Error deleting task:', error);
            }
        }
    </script>
</body>
</html>
